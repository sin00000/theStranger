<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Page</title>

    <!-- Import map for Firebase SDK -->
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        .step { padding: 10px; margin: 10px 0; border-left: 3px solid #333; }
        .success { border-left-color: #0f0; color: #0f0; }
        .error { border-left-color: #f00; color: #f00; }
        .warning { border-left-color: #ff0; color: #ff0; }
        .info { border-left-color: #0ff; color: #0ff; }
        #console { background: #111; padding: 15px; margin-top: 20px; border: 1px solid #333; max-height: 400px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç Interaction Page Diagnostic</h1>
    <div id="output"></div>
    <h2>Console Log:</h2>
    <div id="console"></div>

    <script type="module">
        const output = document.getElementById('output');
        const consoleLog = document.getElementById('console');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.textContent = msg;
            output.appendChild(div);
            console.log(msg);

            const consoleEntry = document.createElement('div');
            consoleEntry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleLog.appendChild(consoleEntry);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        // Capture console errors
        window.addEventListener('error', (e) => {
            log(`‚ùå GLOBAL ERROR: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`‚ùå UNHANDLED PROMISE REJECTION: ${e.reason}`, 'error');
        });

        (async () => {
            log('üöÄ Starting diagnostic...', 'info');

            // Test 1: Check if import map works
            log('TEST 1: Checking import map...', 'info');
            try {
                const { initializeApp } = await import('firebase/app');
                log('‚úÖ Import map works - Firebase SDK loaded from CDN', 'success');
            } catch (error) {
                log(`‚ùå Import map failed: ${error.message}`, 'error');
                log('   This means Firebase SDK cannot be loaded from CDN', 'error');
                return;
            }

            // Test 2: Check if firebase-config.js exists and loads
            log('TEST 2: Loading firebase-config.js...', 'info');
            try {
                const firebaseConfig = await import('./firebase-config.js');
                log('‚úÖ firebase-config.js loaded', 'success');
                log(`   db = ${firebaseConfig.db ? 'initialized' : 'null'}`, firebaseConfig.db ? 'success' : 'warning');
            } catch (error) {
                log(`‚ùå firebase-config.js failed: ${error.message}`, 'error');
                log('   Stack: ' + error.stack, 'error');
                return;
            }

            // Test 3: Check if interaction-firebase.js exists and loads
            log('TEST 3: Loading interaction-firebase.js...', 'info');
            try {
                const interactionFirebase = await import('./interaction-firebase.js');
                log('‚úÖ interaction-firebase.js loaded', 'success');
                log(`   getUserId: ${typeof interactionFirebase.getUserId}`, 'info');
                log(`   loadCustomLetteringsFromFirebase: ${typeof interactionFirebase.loadCustomLetteringsFromFirebase}`, 'info');
            } catch (error) {
                log(`‚ùå interaction-firebase.js failed: ${error.message}`, 'error');
                log('   Stack: ' + error.stack, 'error');
                return;
            }

            // Test 4: Check if firebase-storage.js exists and loads
            log('TEST 4: Loading firebase-storage.js...', 'info');
            try {
                const firebaseStorage = await import('./firebase-storage.js');
                log('‚úÖ firebase-storage.js loaded', 'success');
            } catch (error) {
                log(`‚ùå firebase-storage.js failed: ${error.message}`, 'error');
                log('   Stack: ' + error.stack, 'error');
                return;
            }

            // Test 5: Test canvas creation
            log('TEST 5: Creating canvas...', 'info');
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 800;
                canvas.height = 600;
                ctx.fillStyle = '#ffffff';
                ctx.font = '40px Georgia';
                ctx.fillText('Test', 100, 100);
                log('‚úÖ Canvas works', 'success');
            } catch (error) {
                log(`‚ùå Canvas failed: ${error.message}`, 'error');
                return;
            }

            // Test 6: Test getUserId
            log('TEST 6: Testing getUserId()...', 'info');
            try {
                const { getUserId } = await import('./interaction-firebase.js');
                const userId = getUserId();
                log(`‚úÖ getUserId() returned: ${userId}`, 'success');
            } catch (error) {
                log(`‚ùå getUserId() failed: ${error.message}`, 'error');
                return;
            }

            // Test 7: Test loadCustomLetteringsFromFirebase
            log('TEST 7: Testing loadCustomLetteringsFromFirebase()...', 'info');
            try {
                const { loadCustomLetteringsFromFirebase } = await import('./interaction-firebase.js');
                const result = await loadCustomLetteringsFromFirebase(['A', 'B', 'C']);
                log(`‚úÖ loadCustomLetteringsFromFirebase() returned ${Object.keys(result).length} glyphs`, 'success');
                log(`   Characters: ${Object.keys(result).join(', ') || '(none)'}`, 'info');
            } catch (error) {
                log(`‚ùå loadCustomLetteringsFromFirebase() failed: ${error.message}`, 'error');
                log('   This is OK - it means no glyphs are saved yet', 'warning');
            }

            log('', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
            log('üéâ ALL TESTS PASSED!', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
            log('', 'info');
            log('The interaction page SHOULD work.', 'success');
            log('If it doesn\'t, open interaction.html and check the browser console for errors.', 'info');

        })().catch(error => {
            log(`‚ùå FATAL ERROR: ${error.message}`, 'error');
            log(`Stack: ${error.stack}`, 'error');
        });
    </script>
</body>
</html>
